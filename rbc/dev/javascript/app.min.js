angular.module("HttpClient",["ngCookies"]).provider("httpClient",function(){var a="",b=null,c="",d=this;this.setBaseUrl=function(b){a=b,console.log(a)},this.setToken=function(a){b=a,console.log(b)};var e=function(b){c=a+"/"+b,console.log(c)};this.$get=["$cookies","$q","$http",function(a,f,g){a.get("token")&&(b=a.get("token"));var h=function(a,b,c){return a&&a[b]||(a||(a={}),a[b]=c),a},i=function(a,d){var i=f.defer();return e(a),d.url=c,b&&(d.headers=h(d.headers,"Authorization","Bearer "+b)),g(d).then(function(a){if(a.data){a.data.response||a.data.metadata.success&&(a.data.metadata.statusCode="200",a.data.metadata.status="success");var b=a.data.response?a.data.response:a.data;"200"==b.metadata.statusCode&&"success"==b.metadata.status?b.result&&b.result.metadata?"200"==b.result.statusCode&&"success"==b.result.status?i.resolve(b.result.result?b.result.result:b.result,a):i.reject(b.result.metadata,a):i.resolve(b.result,a):i.reject(b.metadata,a)}},function(a){console.log("ERROR",a),"429"==a.status&&(0==$("body").find(".alert-transport").length&&$("body").append('<div class="alert alert-danger alert-dismissable alert-transport" style="position: absolute; z-index: 1000; top: 0; width: 600px; left: 30%; text-align: center">You have reached you requests rate limit. For more info check the <a href="https://www.scriptr.io/documentation#documentation-ratelimitingRateLimiting" target="blank">documentation.</a><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button></div>'),console.error("You have reached your requests rate limit. For more info check the documentation. https://www.scriptr.io/documentation#documentation-ratelimitingRateLimiting")),a.data&&a.data.response&&a.data.response.metadata?i.reject(a.data.response.metadata):i.reject(a)}),i.promise};return{get:function(a,b){var c={method:"GET"};return c.params=b,i(a,c)},post:function(a,b,c,d){var e={method:"POST"};return e.data=b,c&&(e.headers=c),c&&c["Content-Type"]||(e.headers=h(e.headers,"Content-Type","application/json")),d&&(e.headers["Content-Type"]=void 0,e.transformRequest=angular.identity),i(a,e)},updateToken:function(a){d.setToken(a)}}}]});var wssConfig=["wsClientProvider",function(a){a.setPublishChannel("requestChannel");var b=["responseChannel"],c=JSON.parse(localStorage.getItem("user")).groups;for(ug in c)c[ug].startsWith("cc-")&&b.push(c[ug]);a.setSubscribeChannel(b),a.setBaseUrl(websocketUrl)}],httpsConfig=["httpClientProvider",function(a){}],un=JSON.parse(localStorage.getItem("user")),ugs=un.groups;console.info("user "+un.name+" in groups "+ugs);var headerItems={logo:"{{cdnImagesPath}}saepioLogo2.png",items:[{id:"14",icon:"fa fa-fw fa-tachometer",label:"Dashboard",route:"#/dashboard-home",active:"false"},{id:"13",icon:"fa fa-dot-circle-o",label:"Cluster Detection",route:"#/heatMap",roles:["quarantine-agent"]},{id:"2",icon:"fa fa-users",label:"Users",roles:["quarantine-agent","admin-uploader"],subitems:[{id:"3",iconClass:"fa fa-key",label:"All Users",route:"#/quarantineUsers",roles:["quarantine-agent"]},{id:"7",iconClass:"fa fa-key",label:"Import Users",route:"#/admin",roles:["admin-uploader"]}]},{id:"8",icon:"fa fa-search",label:"Contact Tracing ",roles:["admin-trace"],subitems:[{id:"9",iconClass:"fa fa-key",label:"User tracing",route:"#/trace",roles:["admin-trace"]},{id:"10",iconClass:"fa fa-key",label:"Users at risk",route:"#/contactPositive",roles:["admin-trace"]},{id:"11",iconClass:"fa fa-key",label:"Investigated users",route:"#/investigatedUsers",roles:["admin-trace"]}]}],subitems:[{id:"1",iconClass:"fa fa-key",label:"Change Password",route:"#/changePassword"}],logout:{icon:"fa fa-sign-out",label:"Logout",route:"#/logout"}},routingItems={params:[{route:"map",template:"/app/view/html/views/map/map.html",controller:"mapCtrl as vm"},{route:"map/deviceId/:deviceId*",template:"/app/view/html/views/map/map.html",controller:"mapCtrl as vm"},{route:"dashboard-home",template:"/app/view/html/views/dashboard/dashboard-home2.html",controller:"dashboardHomeCtrl as vm"},{route:"heatMap",template:"/app/view/html/views/dashboard/cluster-detection2.html",controller:"clusterDetectionCtrl as vm"},{route:"dashboard/branchId/:branchId*",template:"/app/view/html/views/dashboard/dashboard2.html",controller:"dashboardCtrl as vm"},{route:"dashboard3/branchId/:branchId*",template:"/app/view/html/views/dashboard/dashboard-details.html",controller:"dashboardCtrl3 as vm"},{route:"pauseRequests",template:"/app/view/html/views/users/pause-requests.html",controller:"pauseRequestCtrl as vm"},{route:"notInQuarantine",template:"/app/view/html/views/users/not-in-quarantine.html",controller:"notInQuarantineCtrl as vm"},{route:"users",template:"/app/view/html/views/users/users-home.html",controller:"devicesHomeCtrl as vm"},{route:"quarantineUsers",routeDef:{isInQuarantine:!0},template:"/app/view/html/views/users/users-home.html",controller:"devicesHomeCtrl as vm"},{route:"pausePermit",routeDef:{isPausePermit:!0},template:"/app/view/html/views/users/users-home.html",controller:"devicesHomeCtrl as vm"},{route:"investigatedUsers",routeDef:{isInvestiagtedUsers:!0},template:"/app/view/html/views/users/users-home.html",controller:"devicesHomeCtrl as vm"},{route:"settings-home",template:"/app/view/html/views/settings/settings-home.html",controller:"settingsHomeCtrl as vm"},{route:"changePassword",template:"/app/view/html/views/login/changePassword.html",controller:"changePasswordCtrl"},{route:"admin",template:"/app/view/html/views/admin/admin-home.html",controller:"adminFormCtrl as vm"},{route:"trace",template:"/app/view/html/views/admin/trace.html",controller:"traceCtrl as vm"},{route:"contactPositive",template:"/app/view/html/views/admin/contactPositive.html",controller:"contactPositiveCtrl as vm"},{route:"trace/deviceId/:deviceId*",template:"/app/view/html/views/admin/trace.html",controller:"traceCtrl as vm"},{route:"logout",template:"/app/view/html/logout.html"}]},groupsLandingPagesItems={"quarantine-agent":"/dashboard-home","admin-trace":"/trace","admin-uploader":"/admin",default:"/"},myApp=angular.module("myApp",["Layout","List","underscore","btford.markdown","schemaForm","Accelerometer","Button","Slider","ToggleSwitch","Grid","Map","Alert","xeditable","ui.bootstrap","ngRoute","slickCarousel","ngAnimate","ngSanitize","WsClient","HttpClient","DataService","Chart","gridster","Gauge","Speedometer","Odometer","SearchBox","ngMaterial","ngMessages","material.svgAssetsCache","Thermometer","angularSpectrumColorpicker","angular-underscore/filters","ui.codemirror","Dygraphs","mgcrea.ngStrap","mgcrea.ngStrap.modal","pascalprecht.translate","ui.select","ui.highlight","mgcrea.ngStrap.select","Display","QmcSearch","QmcGrid","QmcForms","ngSchemaFormFile","Imagemap"]);myApp.constant("headerItemsJson",JSON.parse(Handlebars.compile(JSON.stringify(headerItems))({cdnImagesPath:cdnImagesPath}))).constant("routingJson",routingItems).constant("groupsLandingPages",groupsLandingPagesItems).config(httpsConfig).config(wssConfig).config(["$routeProvider","routingJson","$sceProvider","groupsLandingPages",function(a,b,c,d){for(var e=0;e<b.params.length;e++)a.when("/"+b.params[e].route,{templateUrl:b.params[e].template,controller:b.params[e].controller,reloadOnSearch:!1,routeDef:b.params[e].routeDef});var f=JSON.parse($.cookie().user).groups?JSON.parse($.cookie().user).groups:[];"string"==typeof f&&(f=[f]);var g=_.keys(d),h=_.intersection(g,f);h&&h.length>0?a.otherwise(d[h[0]]):a.otherwise(d.default)}]),myApp.filter("noDecimals",function(){return function(a){return a?Math.floor(a):"N/A"}}),myApp.filter("lastScan",function(){return function(a){return a?moment(parseFloat(a,"MM/DD/YYYY")).calendar():"N/A"}}),myApp.filter("startDate",function(){return function(a){if(a){var b=moment(parseFloat(a)).toNow(!0);return b.charAt(0).toUpperCase()+b.slice(1)}}}),myApp.filter("timeRemaining",function(){return function(a){if(a){var b=moment(parseFloat(a)).fromNow(!0);return b.charAt(0).toUpperCase()+b.slice(1)}}}),myApp.filter("idOnly",function(){return function(a){return a?a.split("_")[0]:"N/A"}}),myApp.filter("setPath",["$sce",function(a){return function(b,c){return b?Handlebars.compile(a.getTrustedHtml(b))(c):b}}]),myApp.constant("infoWindowActions",{endQuarantine:{title:"End Quarantine",form:[{type:"section",htmlClass:"col-xs-12",items:[{type:"section",items:[{key:"comment"}]}]}],schema:{type:"object",title:"Schema",properties:{comment:{title:"Comment",type:"string","x-schema-form":{type:"textarea",placeholder:"Ex: Ending quarantine after developing antibodies."}}},required:["comment"]}},sendSMS:{title:"Send SMS",form:[{type:"section",htmlClass:"col-xs-12",items:[{type:"section",items:[{key:"comment"}]}]}],schema:{type:"object",title:"Schema",properties:{comment:{title:"Comment",type:"string","x-schema-form":{type:"textarea",placeholder:""}}},required:["comment"]}},pauseQuarantine:{title:"Pause Quarantine",form:[{type:"section",items:[{type:"section",htmlClass:"col-xs-12",items:[{key:"time"}]}]},{type:"section",items:[{type:"section",htmlClass:"col-xs-12",items:[{key:"comment"}]}]}],schema:{type:"object",title:"Schema",properties:{time:{type:"number",title:"Time (minutes)"},comment:{title:"Comment",type:"string","x-schema-form":{type:"textarea",placeholder:"Ex: Pausing quarantine for couple of hours until doctor checkup."}}},required:["time","comment"]}}}),myApp.controller("mapCtrl",["wsClient","$location","$scope","constants","$routeParams","httpClient","$sce","$interval","$timeout","$uibModal","infoWindowActions",function(a,b,c,d,e,f,g,h,i,j,k){var l=this;l.showResultLoading=!1,l.deviceKey=null,l.testResult=null,l.testResultColor=null,l.testDate=null,l.sources=d.sources,l.icons=d.infoWindows.icons,l.infoWindowActions=k,l.message={},l.hasAlert=!1,l.showAlert=function(a,b){l.hasAlert=!1,l.message={type:a,content:b},l.hasAlert=!0},l.closeAlert=function(){l.hasAlert=!1},l.cdnImagesPath=cdnImagesPath,l.callApi=function(a,b,c){l.closeAlert(),console.log("calling callAPI api <"+a+"> with params <"+JSON.stringify(b)+">"),f.post(a,b).then(function(a,b){l.showAlert("success",c+" successful"),console.log(a)},function(a){l.showAlert("danger",c+" failure: "+(a.data&&a.data.metadata&&a.data.metadata.description&&a.data.metadata.description.en?a.data.metadata.description.en:"unknown error")),console.log(a)})},l.displayUserId=function(a){var b=!1;return a.details.userId&&a.details.userId.value&&""!=a.details.userId.value.trim()&&(b=!0),b},l.displayPassport=function(a){var b=!1;return!l.displayUserId(a)&&a.details.passport&&a.details.passport.value&&""!=a.details.passport.value.trim()&&(b=!0),b},l.displayOther=function(a){var b=!1;return l.displayUserId(a)||l.displayPassport(a)||!a.details.id||""==a.details.id.trim()||(b=!0),b},l.loadOverlay=function(a,b,d){l.closeAlert();var e=angular.copy(b),f={label:e.title,buttons:{save:{label:"Save"},cancel:{label:"Cancel"}},schema:angular.copy(e.schema),form:angular.copy(e.form),options:{}};j.open({animation:!0,component:"scriptrQmcFormOverlay",size:"lg",scope:c,resolve:{widget:function(){return f}}}).result.then(function(b){if("cancel"!=b){console.log("Model Data",b);var c=function(a){l.showAlert("success",e.title+" successful")},f=function(a){l.showAlert("danger",e.title+" failure: "+a.errorDetail)};b.deviceId=a.details.id.value,l.callBackendApiPost(d,b,c,f)}},function(){console.info("modal-component for widget update dismissed at: "+new Date)})},l.callBackendApiGet=function(a,b,c,d){console.log("GET calling backend api <"+a+"> with params "+JSON.stringify(b)),l._callBackendApi(a,b,"G",c,d)},l.callBackendApiPost=function(a,b,c,d){console.log("POST calling backend api <"+a+"> with params "+JSON.stringify(b)),l._callBackendApi(a,b,"P",c,d)},l._callBackendApi=function(a,b,c,d,e){var g=f.post;"G"==c&&(g=f.get),g(a,b).then(function(a,b){console.log(a),a&&a.status&&"failure"==a.status?"function"==typeof e&&e(a):"function"==typeof d&&d(a)},function(a){console.log(a),"function"==typeof e&&e(a)})},l.getJobStatus=function(a,b,c,d,e){c>0?(c-=1,f.post(a,b,null,!1).then(function(f){if(console.dir(f),"complete"==f.jobStatus){var g=JSON.parse(f.jobResult);if("success"==g.resultJSON.response.metadata.status)return void d(g.resultJSON.response.result);e("An error occurred, please try again later.")}setTimeout(l.getJobStatus,1e3,a,b,c,d,e)},function(a){e(a)})):e("TIME_OUT")},l.updateData=function(a){console.log("Getting an update for info window"),l.showResultLoading=!0;var b={deviceId:a},c=new FormData;for(var d in b)c.append(d,b[d]);f.post("admin/profile/accountDetailsJob",b,null,!1).then(function(a,b){"failure"==a.status?console.log("failure"):l.getJobStatus("admin/profile/accountDetailsJob",{jobId:a.jobId},30,function(a){l.testDate=a.date?a.date:"Not available",l.testResult=a.riskMessage.en,l.testResultColor=a.risk,l.showResultLoading=!1},function(a){l.showResultLoading=!1,console.log("reject",a.data.metadata.description.en)})},function(a){l.showResultLoading=!1,console.log("reject",a.data.metadata.description.en)})},l.go=function(a){b.path(a)},l.init=function(){l.frmGlobalOptions={destroyStrategy:"remove",formDefaults:{feedback:!0}},e&&e.deviceId&&(l.deviceKey=e.deviceId,l.params={id:l.deviceKey},l.tag="dashboard_"+l.deviceKey),a.onReady.then(function(){a.subscribe("removeDeviceFromMap",function(a,b){c.$broadcast("mapRemoveAssets",a)},c.id)})},l.onSelectAsset=function(a){a&&(l.selectedDevice=a,l.params={id:a.assetId})},l.setMarkerIcon=function(a,b){return b.icon=JSON.parse(Handlebars.compile(JSON.stringify(d.quarantineState[b.details.quarantineState&&b.details.quarantineState.value?b.details.quarantineState.value:"default"].mapMarker))({cdnImagesPath:l.cdnImagesPath})),"on"==a.alert.value&&(b.animation=google.maps.Animation.BOUNCE),b}}]),myApp.controller("menuCtrl",["headerItemsJson",function(a){var b=this;b.headerItems=a,b.user=JSON.parse($.cookie("user"))}]),myApp.controller("settingsHomeCtrl",["httpClient","$routeParams","constants",function(a,b,c){this.init=function(){}}]),myApp.controller("dashboardHomeCtrl",["$location","$scope","$rootScope","httpClient","$sce","$timeout","$interval","$routeParams","$mdDialog","constants",function(a,b,c,d,e,f,g,h,i,j){var k=this;k.sources=j.sources,k.icons=j.infoWindows.icons,k.cdnImagesPath=cdnImagesPath,k.view="dashboard",k.user=JSON.parse($.cookie("user")),k.gridsterOptions={floating:!0,defaultSizeY:50,defaultSizeX:50,minRows:1,maxRows:100,columns:10,colWidth:"auto",rowHeight:"50",margins:[10,10],defaultSizeX:2,defaultSizeY:1,mobileBreakPoint:480,minColumns:1,resizable:{enabled:!1},draggable:{enabled:!1}},k.highAlerts=null,k.transientAlerts=null,k.branchesData=null,k.changeState=function(a){k.view=a},k.init=function(){k.getHighAlertData(),k.getTransientAlertData(),k.refreshTimer=g(function(){k.getTransientAlertData()},3e4),k.getBranchesData(),k.getTopBranchesData()},k.colorRows=function(a){if(1==a.data.alert)return"rag-alert"},k.allBranchesColDef=[{headerName:"Branch Name",field:"name"},{headerName:"Address",field:"address",width:200,cellClass:"textWrap"},{headerName:"Floors",field:"floors",cellRenderer:function(a){return a.value.length}},{headerName:"Max Occupancy",field:"max"},{headerName:"Optimal Occupancy",field:"optimal"},{headerName:"Current occupancy",field:"average",autoHeight:"true"},{headerName:"Actions",field:"id",editable:!1,cellRenderer:function(a){var b,c=document.createElement("div");return c.innerHTML='<button class="btn btn-primary btn-approve">View Details</button>',b=c.querySelectorAll(".btn-approve")[0],b.addEventListener("click",function(){k.viewDetails(a)}),c}}],k.topBreachesColDef=[{headerName:"Name",field:"name"},{headerName:"Branch Name",field:"branchName"},{headerName:"Count",field:"breachCount"}],k.getHighAlertData=function(){d.get("rbc/api/getHighAlertData",k.params).then(function(a,b){k.highAlerts=a,console.log("High alerts",a)},function(a){console.log("ERROR",a)})},k.getTransientAlertData=function(){d.get("rbc/api/getTransientAlertData",k.params).then(function(a,b){k.transientAlerts=a,console.log("Transient Data",a)},function(a){console.log("ERROR",a)})},k.highOccupancyBreachesData=null,k.branchesMapData=null,k.topBreachesData=null,k.getTopBranchesData=function(){d.get("rbc/api/getBreaches/top",k.params).then(function(a,b){k.topBreachesData=a,k.topBreachesChart=[{x:_.pluck(a,"name"),y:_.pluck(a,"breachCount")}],console.log("Top Breaches Data",a)},function(a){console.log("ERROR",a)})},k.getBranchesData=function(){d.get("rbc/api/getBranches",k.params).then(function(a,b){k.allBranchesData=a,k.allBranchesFilteredData=angular.copy(a),console.log("All Branches Data",k.branchesData),k.branchesMapData=k.format(a),console.log("Branches Map Data",k.branchesMapData)},function(a){console.log("ERROR",a)})},k.setMarkerIcon=function(a,b){var c=j.source[b.details.type.value][b.details.alert&&b.details.alert.value?"alert":"normal"].mapMarker;return b.icon=JSON.parse(Handlebars.compile(JSON.stringify(c))({cdnImagesPath:k.cdnImagesPath})),1==a.alert.value&&(b.animation=google.maps.Animation.BOUNCE),b},k.onSelectAsset=function(a){},k.format=function(a){for(var b={},c=0;c<a.length;c++){var d=a[c];if(d.latitude){d.lat=Number(d.latitude),d.long=Number(d.longitude),null==b[d.id]&&(b[d.id]={0:[],order:["0"],source:d.source||"simulator"});var e=_.mapObject(d,function(a,b){return{value:a}});null==e.creationDate&&(e.creationDate={value:(new Date).toISOString()}),b[d.id][0].push(e)}}return b},k.viewDetails=function(b){b&&(k.selectedBranch=b),h&&h.branchId!=b.value&&a.path("/dashboard/branchId/"+b.value)},k.viewDetailsByName=function(b){b&&(k.selectedBranch=b.replace(/ /g,"_")),h&&h.branchId!=b.replace(/ /g,"_")&&a.path("/dashboard/branchId/"+b.replace(/ /g,"_"))},k.filterText=null,k.hasFilterText=function(a){return void 0==k.filterText||null==k.filterText||""==k.filterText||-1!=JSON.stringify(_.values(a)).toLowerCase().indexOf(k.filterText.toLowerCase())},k.filterData=function(a){b.$broadcast("runExternalFilter-allBranchesFilteredData",{})},k.filterListGrid=function(a){return void 0==k.filterText||null==k.filterText||""==k.filterText||-1!=JSON.stringify(a.data).toLowerCase().indexOf(k.filterText.toLowerCase())},k.isListGridFilterPresent=function(){return!(void 0==k.filterText&&null==k.filterText&&""==k.filterText)},k.topBreachesTracesConfig=[{type:"scatter",name:"Employees Top Breaches",mode:"markers",marker:{color:"#E06364",line:{color:"rgba(156, 165, 196, 1.0)",width:1},symbol:"circle",size:25}}],k.topBreachesLayoutConfig={title:!1,margin:{l:25,r:15,b:20,t:20},xaxis:{showgrid:!1,showline:!1,title:"Employees Name",titlefont:{font:{color:"rgb(204, 204, 204)"}},tickfont:{font:{color:"rgb(102, 102, 102)"}},ticks:"outside"},yaxis:{showgrid:!1,showline:!1,title:"Breaches Count by Day",titlefont:{font:{color:"rgb(204, 204, 204)"}},tickfont:{font:{color:"rgb(102, 102, 102)"}}},hovermode:"closest",legend:{font:{size:10},yanchor:"top",y:.99,xanchor:"left",x:.01,orientation:"v"}}}]),myApp.controller("dashboardCtrl",["$location","$scope","$rootScope","httpClient","$sce","$timeout","$interval","$routeParams","$mdDialog","constants",function(a,b,c,d,e,f,g,h,i,j){var k=this;k.sources=j.sources,k.icons=j.infoWindows.icons,k.cdnImagesPath=cdnImagesPath,k.dataLoaded=!0,k.view="dashboard",k.changeState=function(a){k.view=a},k.gridsterOptions={defaultSizeY:50,defaultSizeX:50,minRows:1,maxRows:100,columns:10,colWidth:"auto",rowHeight:"50",margins:[10,10],defaultSizeX:2,defaultSizeY:1,mobileBreakPoint:480,minColumns:1,resizable:{enabled:!1},draggable:{enabled:!1}},k.slickConfig={infinite:!0,arrows:!0,autoplay:!1,dots:!0,slidesToShow:1,slidesToScroll:1,prevArrow:"<span class='prevSlide'><i class='fa fa-angle-left'></i></span>",nextArrow:"<span class='nextSlide'><i class='fa fa-angle-right'></i></span>",enabled:!0,method:{},event:{beforeChange:function(a,b,c,d){},afterChange:function(a,b,c,d){}}},k.heatmapLayerOption={minOpacity:.3,maxZoom:0,radius:30,blur:30,max:1,gradient:{.1:"lightblue",.2:"powderblue",.3:"cadetblue",.4:"gold",.5:"gold",.6:"yellow",.7:"coral",.8:"orange",.9:"darkorange",1:"orangered"}},k.init=function(){k.params={branchId:h.branchId},k.branchId=h.branchId;k.getBranchDetails(h.branchId)},k.occupancyByRoom=null,k.occupancyByRoomColDef=[{headerName:"Floor",field:"description",cellRenderer:"group"},{headerName:"Details",field:"current",cellRenderer:function(a){return a.value?"Current "+a.data.current+" (Optimal "+a.data.optimal+")":""}},{headerName:"Area",field:"area"},{headerName:"Max area occupancy",field:"maxOccupancy"},{headerName:"Optimal",field:"optimal"},{headerName:"Current area occupancy",field:"occupancy"}],k.colorRows=function(a){if(a.data.current>=a.data.optimal)return"rag-alert"},k.getNodeChildDetails=function(a){return a.areas?{group:!0,expanded:"gf"===a.name,children:a.areas,key:a.name}:null},k.title="Title of detailed dashboard",k.branchDetails=null,k.getBranchDetails=function(a){d.get("rbc/api/getBranches/"+a,k.params).then(function(b,c){b.remaining=""+Math.max(0,b.optimal-b.average),k.branchDetails=b,console.log("Branch Data "+a,b),k.occupancyByRoom=b.floors,console.log("occupancy by room Data ",k.occupancyByRoom)},function(a){console.log("ERROR",a)})},k.formatHeatmapData=function(a){var b=[];return _.forEach(_.pluck(a,"mapLocation"),function(a){b=b.concat(a)}),b},k.floorPlanListCallback=function(a,b){a=a.floors;var c=[];return b.localData&&0!=b.localData.length?b.localData.length>0&&(c=b.localData.concat(a)):c=c.concat(a),_.uniq(c,"name")},k.floorPlanListSelect=function(a){void 0!=a&&a&&(self.selectedFloor=a.originalObject.name,k.slickConfig.method.slickGoTo(_.findIndex(k.branchDetails.floors,{name:self.selectedFloor})))},k.floorPlanListChange=function(a){},k.filterText=null,k.hasFilterText=function(a){return void 0==k.filterText||null==k.filterText||""==k.filterText||-1!=JSON.stringify(_.values(a)).toLowerCase().indexOf(k.filterText.toLowerCase())},k.filterData=function(a){b.$broadcast("runExternalFilter-allFloorsFilteredData",{})},k.filterListGrid=function(a){return void 0==k.filterText||null==k.filterText||""==k.filterText||-1!=JSON.stringify(a.data).toLowerCase().indexOf(k.filterText.toLowerCase())},k.isListGridFilterPresent=function(){return!(void 0==k.filterText&&null==k.filterText&&""==k.filterText)}}]),myApp.controller("clusterDetectionCtrl",["$location","$scope","$rootScope","httpClient","$sce","$timeout","$interval","$routeParams","$mdDialog","constants",function(a,b,c,d,e,f,g,h,i,j){var k=this;k.sources=j.sources,k.icons=j.infoWindows.icons,k.cdnImagesPath=cdnImagesPath,k.view="list",k.user=JSON.parse($.cookie("user")),k.gridsterOptions={floating:!0,defaultSizeY:50,defaultSizeX:50,minRows:1,maxRows:100,columns:10,colWidth:"auto",rowHeight:"50",margins:[10,10],defaultSizeX:2,defaultSizeY:1,mobileBreakPoint:480,minColumns:1,resizable:{enabled:!1},draggable:{enabled:!1}},k.branchesData=null,k.changeState=function(a){k.view=a},k.init=function(){k.refreshTimer=g(function(){k.getBranchesData()},3e4),k.getBranchesData()},k.colorRows=function(a){if(1==a.data.alert)return"rag-alert"},k.highOccupancyBreachesColDef=[{headerName:"Branch Name",field:"name",cellRenderer:"group"},{headerName:"Address",field:"address",width:200,cellClass:"textWrap"},{headerName:"Floors",field:"description",cellRenderer:"group"},{headerName:"Area",field:"area"},{headerName:"Max Occupancy",field:"max"},{headerName:"Optimal Occupancy",field:"optimal"},{headerName:"Current occupancy",field:"average",autoHeight:"true"}],k.getNodeChildDetails=function(a){return a.floors?{group:!0,children:a.floors,key:a.description}:a.areas?{group:!0,children:a.areas,key:a.name}:null},k.getBranchesData=function(){d.get("rbc/api/getBranches",k.params).then(function(a,b){console.log("All Branches Data",a);var c=_.filter(a,function(a){if(1==a.alert)return!0}),c=_.forEach(c,function(a){return a.floors=_.forEach(_.filter(a.floors,function(a){return a.current>a.optimal}),function(a){return delete a.name,a})});_.forEach(c,function(a){return _.forEach(a.floors,function(a){a.areas=_.filter(a.areas,function(a){return a.occupancy>a.optimal})})});k.highOccupancyBreachesData=c,console.log("All Branches Data",k.highOccupancyBreachesData)},function(a){console.log("ERROR",a)})},k.viewDetails=function(b){b&&(k.selectedBranch=b),h&&h.branchId!=b.value&&a.path("/dashboard/branchId/"+b.value)},k.viewDetailsByName=function(b){b&&(k.selectedBranch=b.replace(/ /g,"_")),h&&h.branchId!=b.replace(/ /g,"_")&&a.path("/dashboard/branchId/"+b.replace(/ /g,"_"))},k.filterText=null,k.hasFilterText=function(a){return void 0==k.filterText||null==k.filterText||""==k.filterText||-1!=JSON.stringify(_.values(a)).toLowerCase().indexOf(k.filterText.toLowerCase())},k.filterData=function(a){b.$broadcast("runExternalFilter-highOccupancyBreachesData",{})},k.filterListGrid=function(a){return void 0==k.filterText||null==k.filterText||""==k.filterText||-1!=JSON.stringify(a.data).toLowerCase().indexOf(k.filterText.toLowerCase())},k.isListGridFilterPresent=function(){return!(void 0==k.filterText&&null==k.filterText&&""==k.filterText)}}]),myApp.controller("devicesHomeCtrl",["$location","$scope","$rootScope","httpClient","$routeParams","$timeout","$mdDialog","infoWindowActions","$uibModal","$route",function(a,b,c,d,e,f,g,h,i,j){var k=this;k.infoWindowActions=h,k.isInQuarantine=!(!j.current.$$route.routeDef||!j.current.$$route.routeDef.isInQuarantine),k.isInvestigatedUsers=!(!j.current.$$route.routeDef||!j.current.$$route.routeDef.isInvestiagtedUsers),k.isPausePermit=!(!j.current.$$route.routeDef||!j.current.$$route.routeDef.isPausePermit),k.gridClass="",k.gridAPI="admin/profile/list",k.title="User Verification",k.isInvestigatedUsers&&(k.title="Investigated Users",k.gridClass="gridClickable"),k.isInQuarantine&&(k.title="Users"),k.isPausePermit&&(k.gridAPI="admin/profile/listPausePermit",k.title="Pause Permit Requests"),k.cities=["Others"],k.timerLabels=["1hr","2hrs","3hrs","4hrs","5hrs","6hrs"],k.timerValues=["60","120","180","240","300","360"],k.devicesColDefRef=[{headerName:"Date",field:"creationDate",width:180,cellClass:"textWrap",editable:!1,headerCheckboxSelection:!1,checkboxSelection:!1,cellRenderer:function(a){if(a.value){var b=moment(a.value);return b.isValid()||(b=moment(parseInt(a.value)),b.isValid()||(b=moment.unix(parseInt(a.value)))),b.format("DD-MMM-YYYY hh:mma")}return a.value}},{headerName:"Id",field:"id",width:180,cellClass:"textWrap",editable:!1,cellRenderer:function(a){return a.value?a.value.split("_")[0]:"N/A"}},{headerName:"Name",field:"nameEn",width:200,cellClass:"textWrap",editable:!1},{headerName:"Phone Number",field:"mobile",width:150,editable:!1},{headerName:"Photo",field:"photo",width:100,editable:!1,cellRenderer:function(a){var b=document.createElement("div");return b.innerHTML='<button class="deviceImg btn btn-primary btn-block" type="button">View</button>',b.querySelectorAll(".deviceImg")[0].addEventListener("click",function(b){k.showDevicePhotosDialog(a)}),b}},{headerName:"City",field:"city",width:150,cellEditor:"select",editable:!0,cellEditorParams:{values:k.cities}},{headerName:"Timer",field:"timer",width:150,cellEditor:"select",editable:!0,cellEditorParams:{values:k.timerLabels},cellRenderer:function(a){return a.value||(a.value=k.timerLabels[0]),a.value}}],k.pausePermitColDefRef=[{headerName:"Date",field:"startDate",cellClass:"textWrap",editable:!1,headerCheckboxSelection:!1,checkboxSelection:!1,cellRenderer:function(a){if(a.value){var b=moment(parseInt(a.value));return b.isValid()||(b=moment.unix(parseInt(a.value))),b.format("DD-MMM-YYYY hh:mma")}return a.value}},{headerName:"Id",field:"deviceId",cellClass:"textWrap",editable:!1,cellRenderer:function(a){return a.value?a.value.split("_")[0]:"N/A"}},{headerName:"Comments",field:"comments",cellClass:"textWrap",width:300,editable:!1},{headerName:"Time",field:"pausePermitTime",cellEditor:"select",editable:!0,cellStyle:{cursor:"pointer"},cellEditorParams:{values:k.timerLabels},cellRenderer:function(a){return a.value||(a.value=k.timerLabels[0]),a.value}},{headerName:"Actions",field:"workflowState",editable:!1,cellRenderer:function(a){var b,c=document.createElement("div");return"entryPoint"==a.value?(c.innerHTML='<button class="btn btn-primary btn-approve">Approve</button> <button class="btn btn-primary btn-reject">Reject</button>',b=c.querySelectorAll(".btn-approve")[0],b.addEventListener("click",function(){k.approvePausePermit(a)}),b=c.querySelectorAll(".btn-reject")[0],b.addEventListener("click",function(){k.rejectPausePermit(a)}),c):"approved"==a.value?"<i class='fa fa-check-circle' aria-hidden='true'></i>":"approving"==a.value?"Approval in progress":a.value}}],k.actionColDef={headerName:"Actions",field:"workflowState",editable:!1,cellRenderer:function(a){var b,c=document.createElement("div");return a.value&&"pendingValidation"==a.value?(c.innerHTML='<button class="btn btn-primary btn-approve">Approve</button> <button class="btn btn-primary btn-reject">Reject</button>',b=c.querySelectorAll(".btn-approve")[0],b.addEventListener("click",function(){k.approve(a)}),b=c.querySelectorAll(".btn-reject")[0],b.addEventListener("click",function(){k.reject(a)}),c):"approved"==a.value?"<i class='fa fa-check-circle' aria-hidden='true'></i>":"rejected"==a.value?"<i class='fa fa-ban' aria-hidden='true'></i>":"pendingHomeCheckin"==a.value?"<i class='fa fa-hourglass' aria-hidden='true'></i>":"breachCheckinTimer"==a.value?(c.innerHTML='<button class="btn btn-primary btn-approve">Extend timer</button>',b=c.querySelectorAll(".btn-approve")[0],b.addEventListener("click",function(){k.extend(a)}),c):"approving"==a.value?"Approval in progress":"rejecting"==a.value?"Rejection in progress":"extending"==a.value?"Timer extension in progress":a.value}},k.quarantineFields=[{headerName:"Last Scan",field:"lastScanDate",width:180,cellClass:"textWrap",editable:!1,cellRenderer:function(a){if(!a||!a.value)return"";var b=moment(parseInt(a.value));return b.isValid()?b.format("MM-DD-YYYY hh:mm A"):void 0}},{headerName:"Test Result",field:"testResult",width:100,cellClass:"textWrap",editable:!1,cellRenderer:function(a){return a.value&&"true"==a.value.progress?'<i class="fa fa-spinner fa-spin fa-1x"></i>':a.value||""}},{headerName:"Test Date",field:"testDate",width:180,cellClass:"textWrap",editable:!1,cellRenderer:function(a){return a.value&&"true"==a.value.progress?'<i class="fa fa-spinner fa-spin fa-1x"></i>':"N/A"==a.value?"Not available":a.value?moment(a.value).format("DD-MMM-YYYY hh:mma"):a.value||""}}],k.quarantineActionColDef={headerName:"Actions",field:"workflowStateX",editable:!1,width:350,cellRenderer:function(a){if(a.value)return a.value+" in progress";var b=document.createElement("div"),c='<button class="btn btn-primary btn-getTestResult">Get Test Result</button>';c+=' <button class="btn btn-primary btn-contactTracing">Trace</button>',b.innerHTML=c,b.querySelectorAll(".btn-contactTracing")[0].addEventListener("click",function(){window.location=window.location.origin+"/qmc/index#/trace/deviceId/"+a.data.id});var d=b.querySelectorAll(".btn-getTestResult")[0],e=function(b){"failure"==b.status?f({errorDetail:"unknown error",data:b}):b.jobId?k.getJobStatus("admin/profile/accountDetailsJob",{jobId:b.jobId},30,e,f):(a.data.testDate=b.date?b.date:"N/A",a.data.testResult=b.riskMessage.en,a.data.workflowStateX=null,k.showAlert("success","Test results retrieved for "+a.data.nameEn),a.$scope.rowNode.setData(a.data))},f=function(b){console.log(b);var c=b.errorDetail||(b.data&&b.data.metadata&&b.data.metadata.description?b.data.metadata.description.en:"N/A");k.showAlert("danger","Test results failed for "+a.data.nameEn+": "+c),a.data.testResult="N/A",a.data.testDate="N/A",a.data.workflowStateX=null,a.$scope.rowNode.setData(a.data)};return d.addEventListener("click",function(){k.closeAlert(),a.data.testResult={progress:"true"},a.data.testDate={progress:"true"},a.data.workflowStateX="Test Result",a.$scope.rowNode.setData(a.data),k.callBackendApiPost("admin/profile/accountDetailsJob",{deviceId:a.data.id},e,f)}),b}},k.rejectPausePermit=function(a){
a.data.workflowState="rejecting",a.$scope.rowNode.setData(a.data);var b={dockey:a.data.key,action:"reject"};console.log("rejecting with parameters = "+JSON.stringify(b)),d.post("admin/quarantine/pausePermit/update",b).then(function(b,c){if(b.status&&"failure"==b.status)return a.data.workflowState="entryPoint",a.$scope.rowNode.setData(a.data),void k.showAlert("danger",b.errorDetail);a.data.workflowState="rejected",a.$scope.rowNode.setData(a.data),k.showAlert("success","Rejection successful!"),console.log("[admin/profile/reject] response",b)},function(b){if("success"==b.status)return a.data.workflowState="rejected",a.$scope.rowNode.setData(a.data),k.showAlert("success","Rejection successful!"),void console.log("[admin/profile/reject] response",a.data);a.data.workflowState="entryPoint",a.$scope.rowNode.setData(a.data);var c="Unknown error";b.data&&b.data.metadata&&b.data.metadata.description&&b.data.metadata.description.en?c=b.data.metadata.description.en:b.errorDetail&&(c=b.errorDetail),k.showAlert("danger",c),console.log("[admin/quarantine/pausePermit/update] response",c)})},k.approvePausePermit=function(a){a.data.workflowState="approving",a.$scope.rowNode.setData(a.data),void 0!=a.data.pausePermitTime&&null!=a.data.pausePermitTime||(a.data.pausePermitTime=k.timerLabels[0]);var b={dockey:a.data.key,action:"approve",time:k.timerValues[k.timerLabels.indexOf(a.data.pausePermitTime)]};console.log("approving with parameters = "+JSON.stringify(b)),d.post("admin/quarantine/pausePermit/update",b).then(function(b,c){if(b.status&&"failure"==b.status)return a.data.workflowState="entryPoint",a.$scope.rowNode.setData(a.data),void k.showAlert("danger",b.errorDetail);a.data.workflowState="approved",a.$scope.rowNode.setData(a.data),k.showAlert("success","Approval successful!"),console.log("[admin/profile/verify] response",b)},function(b){if(console.dir(b),"success"==b.status)return a.data.workflowState="approved",a.$scope.rowNode.setData(a.data),k.showAlert("success","Approval successful!"),void console.log("[admin/profile/verify] response",a.data);a.data.workflowState="entryPoint",a.$scope.rowNode.setData(a.data);var c="Unknown error";b.data&&b.data.metadata&&b.data.metadata.description&&b.data.metadata.description.en?c=b.data.metadata.description.en:b.errorDetail&&(c=b.errorDetail),k.showAlert("danger",c),console.log("[admin/profile/verify] response",c)})},k.onRowDoubleClicked=function(a){k.isInvestigatedUsers&&(window.location=window.location.origin+"/qmc/index#/trace/deviceId/"+a.data.id)},k.getJobStatus=function(a,b,c,e,f){c>0?(c-=1,d.post(a,b,null,!1).then(function(d){if(console.dir(d),"complete"==d.jobStatus){var g=JSON.parse(d.jobResult);if("success"==g.resultJSON.response.metadata.status)return void e(g.resultJSON.response.result);f("An error occurred, please try again later.")}setTimeout(k.getJobStatus,1e3,a,b,c,e,f)},function(a){f(a)})):f("TIME_OUT")},k.loadOverlay=function(a,c,d){k.closeAlert();var e=angular.copy(c),f={label:e.title,buttons:{save:{label:"Save"},cancel:{label:"Cancel"}},schema:angular.copy(e.schema),form:angular.copy(e.form),options:{}};i.open({animation:!0,component:"scriptrQmcFormOverlay",size:"lg",scope:b,resolve:{widget:function(){return f}}}).result.then(function(b){if("cancel"!=b){console.log("Model Data",b);var c=function(a){k.showAlert("success",e.title+" successful")},f=function(a){k.showAlert("danger",e.title+" failure: "+a.errorDetail)};b.deviceId=a.data.id,k.callBackendApiPost(d,b,c,f)}},function(){console.info("modal-component for widget update dismissed at: "+new Date)})},k.updateColDef=function(a){return k.isPausePermit?void(k.devicesColDef=k.pausePermitColDefRef):(k._devicesColDef=k.devicesColDefRef.slice(0,k.devicesColDefRef.length),k.isInvestigatedUsers||k.isInQuarantine?(k._devicesColDef[5]&&k._devicesColDef.splice(4,k._devicesColDef.length),k.isInvestigatedUsers&&(k._devicesColDef[0].field="process-tracing-data-time"),k.isInQuarantine&&(k._devicesColDef=k._devicesColDef.concat(k.quarantineFields),k._devicesColDef.push(k.quarantineActionColDef)),k._devicesColDef.shift(),void(k.devicesColDef=k._devicesColDef)):("rejected"==a||"pendingHomeCheckin"==a?(k._devicesColDef[5].editable=!1,k._devicesColDef[5].cellStyle={cursor:"default"},k._devicesColDef[6].editable=!1,k._devicesColDef[6].cellStyle={cursor:"default"}):(k._devicesColDef[5].editable=!0,k._devicesColDef[5].cellStyle={cursor:"pointer"},k._devicesColDef[6].editable=!0,k._devicesColDef[6].cellStyle={cursor:"pointer"},k._devicesColDef.push(k.actionColDef)),void(k.devicesColDef=k._devicesColDef)))},k.approve=function(a){if(a.data.workflowState="approving",a.$scope.rowNode.setData(a.data),void 0==a.data.city||null==a.data.city)a.data.workflowState="pendingValidation",a.$scope.rowNode.setData(a.data),k.showAlert("danger","City is required!");else if(-1==k.cities.indexOf(a.data.city))a.data.workflowState="pendingValidation",a.$scope.rowNode.setData(a.data),k.showAlert("danger","City is invalid!");else if(a.data.timer&&-1==k.timerLabels.indexOf(a.data.timer))a.data.workflowState="pendingValidation",a.$scope.rowNode.setData(a.data),k.showAlert("danger","Check-in Time is invalid!");else{console.log("timer = "+a.data.timer),void 0!=a.data.timer&&null!=a.data.timer||(a.data.timer=k.timerLabels[0]);var b={deviceId:a.data.id,city:a.data.city,time:k.timerValues[k.timerLabels.indexOf(a.data.timer)]};console.log("approving with parameters = "+JSON.stringify(b)),d.post("admin/profile/verify",b).then(function(b,c){a.data.workflowState="approved",a.$scope.rowNode.setData(a.data),k.showAlert("success","Approval successful!"),console.log("[admin/profile/verify] response",b)},function(b){a.data.workflowState="pendingValidation",a.$scope.rowNode.setData(a.data);var c="Unknown error";b.data&&b.data.metadata&&b.data.metadata.description&&b.data.metadata.description.en?c=b.data.metadata.description.en:b.errorDetail&&(c=b.errorDetail),k.showAlert("danger",c),console.log("[admin/profile/verify] response",c)})}},k.reject=function(a){a.data.workflowState="rejecting",a.$scope.rowNode.setData(a.data);var b={deviceId:a.data.id};console.log("rejecting with parameters = "+JSON.stringify(b)),d.post("admin/profile/reject",b).then(function(b,c){a.data.workflowState="rejected",a.$scope.rowNode.setData(a.data),k.showAlert("success","Rejection successful!"),console.log("[admin/profile/reject] response",b)},function(b){a.data.workflowState="pendingValidation",a.$scope.rowNode.setData(a.data);var c="Unknown error";b.data&&b.data.metadata&&b.data.metadata.description&&b.data.metadata.description.en?c=b.data.metadata.description.en:b.errorDetail&&(c=b.errorDetail),k.showAlert("danger",c),console.log("[admin/profile/reject] response",c)})},k.extend=function(a){if(void 0==a.data.city||null==a.data.city)k.showAlert("danger","City is required!");else if(-1==k.cities.indexOf(a.data.city))k.showAlert("danger","City is invalid!");else if(a.data.timer&&-1==k.timerLabels.indexOf(a.data.timer))k.showAlert("danger","Check-in Time is invalid!");else{a.data.workflowState="extending",a.$scope.rowNode.setData(a.data),console.log("timer = "+a.data.timer),void 0!=a.data.timer&&null!=a.data.timer||(a.data.timer=k.timerLabels[0]);var b={deviceId:a.data.id,city:a.data.city,time:k.timerValues[k.timerLabels.indexOf(a.data.timer)]};console.log("extending with parameters = "+JSON.stringify(b)),d.post("admin/profile/extendHomeCheckin",b).then(function(b,c){a.data.workflowState="pendingHomeCheckin",a.$scope.rowNode.setData(a.data),k.showAlert("success","Extension successful!"),console.log("[admin/profile/extendHomeCheckin] response",b)},function(b){a.data.workflowState="breachCheckinTimer",a.$scope.rowNode.setData(a.data);var c="Unknown error";b.data&&b.data.metadata&&b.data.metadata.description&&b.data.metadata.description.en?c=b.data.metadata.description.en:b.errorDetail&&(c=b.errorDetail),k.showAlert("danger",c),console.log("[admin/profile/extendHomeCheckin] response",c)})}},k.showDevicePhotosDialog=function(a){g.show({controller:"photoDialogCtrl",controllerAs:"vm",templateUrl:"/app/view/html/views/users/user-photos.html",clickOutsideToClose:!0,escapeToClose:!0,locals:{deviceData:a.data},ok:"Close"})},k.init=function(){k.workflowState="pendingValidation",k.isInvestigatedUsers?(k.workflowState=null,k.lastProcessData="true",k.investigatedUsersState="all"):k.isInQuarantine?(k.workflowState=null,k.quarantineState="all"):k.isPausePermit&&(k.workflowState=null,k.pausePermit="pending"),k.updateColDef(k.workflowState),k.params={state:k.workflowState,lastProcessData:k.lastProcessData,quarantineState:k.quarantineState,pausePermit:k.pausePermit},k.renderGrid=!0},k.changeState=function(a,b,c){k.renderGrid=!1,console.log("changeState",a),console.log("contactTracingState",b),a?(k.params={state:a},k.updateColDef(a)):b?k.params="all"==b?{lastProcessData:k.lastProcessData}:{contactTracingState:b}:c&&(k.params={quarantineState:c}),f(function(){k.renderGrid=!0},500)},k.showAlert=function(a,b){k.message={type:a,content:b},f(function(){k.hasAlert=!0},500)},k.closeAlert=function(){k.hasAlert=!1},k.callBackendApiGet=function(a,b,c,d){console.log("GET calling backend api <"+a+"> with params "+JSON.stringify(b)),k._callBackendApi(a,b,"G",c,d)},k.callBackendApiPost=function(a,b,c,d){console.log("POST calling backend api <"+a+"> with params "+JSON.stringify(b)),k._callBackendApi(a,b,"P",c,d)},k._callBackendApi=function(a,b,c,e,f){var g=d.post;"G"==c&&(g=d.get),g(a,b).then(function(a,b){console.log(a),a&&a.status&&"failure"==a.status?"function"==typeof f&&f(a):"function"==typeof e&&e(a)},function(a){console.log(a),"function"==typeof f&&f(a)})}}]),myApp.controller("photoDialogCtrl",["httpClient","deviceData","$mdDialog",function(a,b,c){var d=this;d.isLoading=!0,d.loadStatus="Loading photos...",d.deviceId=b.id,d.deviceName=b.nameEn,d.photo1Loaded=!1,d.photo2Loaded=!1,d.photo1Src="",d.photo2Src="",d.init=function(){a.get("admin/profile/getPhotos",{deviceId:d.deviceId}).then(function(a,b){d.isLoading=!1,console.log("[admin/profile/getPhotos] response",a),null!=a[0]?(d.photo1Loaded=!0,d.photo1Src="data:"+a[0].contentType+";base64, "+a[0].content):d.loadStatus="One or more missing photos",null!=a[1]?(d.photo2Loaded=!0,d.photo2Src="data:"+a[1].contentType+";base64, "+a[1].content):d.loadStatus="One or more missing photos"},function(a){d.isLoading=!1;var b="Unknown error";a.data&&a.data.metadata&&a.data.metadata.description&&a.data.metadata.description.en?b=a.data.metadata.description.en:a.errorDetail&&(b=a.errorDetail),console.log("[admin/profile/getPhotos] error",b),d.loadStatus=b})},d.closeDialog=function(){c.hide()}}]),myApp.controller("contactPositiveCtrl",["httpClient","$routeParams",function(a,b){var c=this;c.devicesColDef=[{headerName:"Id",field:"id",editable:!1,width:300,cellRenderer:function(a){return a.value.split("_")[0]}},{headerName:"Name",field:"nameEn",editable:!1},{headerName:"Phone Number",field:"mobile",editable:!1}],c.init=function(){console.log("contactPositiveCtrl init"),c.params={contact:"true"},c.renderGrid=!0},c.showAlert=function(a,b){c.message={type:a,content:b},c.hasAlert=!0},c.closeAlert=function(){this.hasAlert=!1}}]),myApp.constant("adminConfig",{uploaderForm:{form:[{type:"section",items:[{type:"section",items:[{key:"image",type:"nwpFileUpload",i18n:{add:"Open file browser",preview:"Preview Upload",filename:"File Name",progress:"Progress Status",upload:"Upload",dragorclick:"Drag and drop your file here or click here",required:"Required"},notitle:!1}]}]}],schema:{type:"object",title:"Schema",properties:{image:{title:"File",type:"array",format:"singlefile",default:"fileattach.png","x-schema-form":{type:"array"},pattern:{mimeType:"text/csv",validationMessage:"Wrong File Type. Allowed types "},maxSize:{maximum:"10MB",validationMessage:"File exceeded allowed size of "}}},required:["image"]}}}),myApp.controller("adminFormCtrl",["$location","$scope","$rootScope","httpClient","$sce","$q","adminConfig",function(a,b,c,d,e,f,g){var h=this;h.showLoading=!1,h.init=function(){var a=angular.copy(g.uploaderForm);h.frmGlobalOptions={destroyStrategy:"remove",formDefaults:{feedback:!0}},h.schema=angular.copy(a.schema),h.form=angular.copy(a.form),h.model={}},h.resetForm=function(a){h.model={},b.$broadcast("schemaFormRedraw")},h.save=function(a){if(b.$broadcast("schemaFormValidate"),a.$valid){h.showLoading=!0;var c=f.defer(),e=angular.copy(h.model);a.uploadForm.file.$dirty&&(e.file=a.uploadForm.file.$modelValue),delete e.image;var g=new FormData;for(var i in e)g.append(i,e[i]);return d.post("admin/api/uploadQuarantineFileJob",g,null,!0).then(function(a,b){h.showLoading=!1,"failure"==a.status?h.showAlert("danger",a.errorDetail):h.getJobStatus("admin/api/uploadQuarantineFileJob",{jobId:a.jobId},30,function(){h.showAlert("success","The dashboard has been saved successfully."),h.showLoading=!1,c.resolve(a,b)},function(a,b){h.showAlert("danger",b||a),h.showLoading=!1,c.reject(a,b)})},function(a){h.showAlert("danger",a.data.response.metadata.errorDetail),h.showLoading=!1,console.log("reject",a.data.response.metadata.errorDetail),c.reject(a)}),c.promise}},h.getJobStatus=function(a,b,c,e,f){if(c>0){c-=1;var g=new FormData;for(var i in b)g.append(i,b[i]);d.post(a,g,null,!0).then(function(d){if("complete"==d.jobStatus){var g=JSON.parse(d.jobResult);return"success"==g.resultJSON.response.result?void e(g.result):void f("An error occurred, please try again later.")}setTimeout(h.getJobStatus,1e3,a,b,c,e,f)},function(a){f(a)})}else f("TIME_OUT")},h.showAlert=function(a,b){h.message={type:a,content:b},h.hasAlert=!0},h.closeAlert=function(){this.hasAlert=!1}}]),myApp.constant("searchConfig",{searchForm:{form:[{type:"section",items:[{type:"section",htmlClass:"fa fa-search",items:[{key:"searchBox",type:"string",notitle:!0,default:"Arial",placeholder:"search by employee id"}]}]}],schema:{type:"object",title:"Schema",properties:{searchBox:{type:"string"}},required:["searchBox"]}}}),myApp.controller("traceCtrl",["$location","$scope","$rootScope","httpClient","$sce","$q","searchConfig","$routeParams","$mdDialog","$timeout",function(a,b,c,d,e,f,g,h,i,j){var k=this;k.devMode=!1,k.getDevModeWarning=function(){return k.devMode?"- dev mode !!":""},k.loadingDiv='<i class="fa fa-spinner fa-spin fa-2x fa-fws"></i>',k.latestTriggeredMap={},k.showSearchLoading=!1,k.showTestResultLoading=!1,k.success=!1,k.showGrid=!0,k.showSearch=!0,k.mainLoading=!1,k.hasDeviceId=!1,k.backTriggered=!0,k.gridData=[],k.defaultErrorMsg="An error occurred please try again later.",k.backendApiGetProfile="admin/profile/get",k.backendApiFlagAmber="admin/profile/flagInvestigatedDeviceJob",k.backendApiGetEncounters="scriptrTrace/ui/api/getEncountersV2Job",k.backendApiAccountDetails="admin/profile/accountDetailsJob",k.backendApiScheduleTriggerDataUpload="scriptrTrace/api/scheduleTriggerDataUpload",k.init=function(){k.frmGlobalOptions={destroyStrategy:"remove",formDefaults:{feedback:!0}},h&&h.deviceId&&k.getDeviceFromParams();var a=angular.copy(g.searchForm);k.schema=angular.copy(a.schema),k.form=angular.copy(a.form),k.model={},k.gridOptionsRef=[{headerName:"Name",cellClass:"textWrap",field:"nameEn",width:200},{headerName:"Date/Time",cellClass:"textWrap",field:"encounterDate",width:150},{headerName:"ID",cellClass:"textWrap",field:"identifier",width:150},{headerName:"Mobile Number",cellClass:"textWrap",field:"mobile",width:150},{headerName:"Minutes",field:"encounterMinutes",width:70},{headerName:"Phone Type",cellClass:"textWrap",field:"phoneType",width:200},{headerName:"Distance",cellClass:"textWrap",field:"distance",width:100,valueGetter:function(a){return a.data},cellRenderer:function(a){return a.value&&a.value.distance&&"risky"==a.value.distance?"Within 2m":"Outside 2m"}},{headerName:"Risk Level",field:"severity",width:120,valueGetter:function(a){return a.data},cellRenderer:function(a){return"high"==a.value.severity?'<span><i class="fa fa-flag red" aria-hidden="true"></i></span>':"medium"==a.value.severity?'<span><i class="fa fa-flag orange" aria-hidden="true"></i></span>':'<span><i class="fa fa-flag blue" aria-hidden="true"></i></span>'}}],k.gridOptions=k.gridOptionsRef.slice(0),k.gridOptionsAction={headerName:"Action",field:"severity",width:120,cellRenderer:function(a){var b=document.createElement("div");return b.innerHTML='<button class="btn btn-primary btn-flag-amber">Flag as risky</button>',b.querySelectorAll(".btn-flag-amber")[0].addEventListener("click",function(){k.doConfirmAmberFlag(a)}),b}},k.gridUsers=[{headerName:"Student Id",field:"userId",width:300},{headerName:"Name",field:"nameEn",width:300},{headerName:"Mobile Number",field:"mobile",width:300}]},k.showAlert=function(a,b){k.message={type:a,content:b},k.hasAlert=!0,window.scrollTo(0,0)},k.closeAlert=function(){this.hasAlert=!1},k.getUsersInfo=function(){k.gridUsers.api.setRowData(k.usersInfo)},k.handleUserRowClick=function(a){k.userInfo=a.data,k.latestTriggered=!1,k.mainLoading=!1,k.getTestData(),k.loadContacts()},k.getDeviceFromParams=function(){k.hasDeviceId=!0,k.mainLoading=!0,k.showSearch=!1,k.latestTriggered=!1,k.deviceId=h.deviceId.replace(/\s/g,""),k.searchPassport=h.deviceId.replace(/\s/g,""),k.latestTriggeredMap[k.searchPassport]=!1,k.getProfile(h.deviceId)},k.backToSearch=function(){k.mainLoading=!0,k.backTriggered=!0,h&&h.deviceId?k.getDeviceFromParams():(k.showSearch=!0,k.latestTriggered=k.latestTriggeredMap[k.searchPassport],k.deviceId=k.searchPassport,k.showGrid=!0,k.getProfile())},k.getJobStatus=function(a,b,c,e,f){c>0?(c-=1,d.post(a,b,null,!1).then(function(d){if(console.dir(d),"complete"==d.jobStatus){var g=JSON.parse(d.jobResult);if(g.errorJSON)return f(k.defaultErrorMsg);if("success"==g.resultJSON.response.metadata.status)return void e(g.resultJSON.response.result);f(k.defaultErrorMsg)}if(null!=d.result&&d.result.jobDone)return void e(d.result);setTimeout(k.getJobStatus,3e3,a,b,c,e,f)},function(a){f(a)})):f("TIME_OUT")},k.handleRowClick=function(a){k.backTriggered=!1;var b=a.data.id.replace(/\s/g,"");k.deviceId=b,k.showSearch=!1,k.showGrid=!0,k.getProfile(b),k.loadContacts(b),k.latestTriggered=k.latestTriggeredMap[k.deviceId]},k.loadContacts=function(a){k.loading=!0,k.noContacts=!1,void 0!==a&&"object"!=typeof a||(a=k.userInfo.id),j(function(){var a=document.getElementById("userInfoDiv");a&&a.scrollIntoView()},500),d.get(k.backendApiGetEncounters,{deviceId:a}).then(function(b,c){b?k.getJobStatus(k.backendApiGetEncounters,{jobId:b,deviceId:a},30,function(a){if(a){var b=[];if(0==Object.keys(a).length&&k.devMode)for(var c=Math.floor(10*Math.random()+1),d=1;d<=c;d++){var e={nameEn:"bogus name en "+d,identifier:"bogus identifier long "+d,mobile:"bogus mobile 971000"+d,id:"bogus id 000"+d,encounterDate:moment().format("MM/DD/YYYY hh:mm A"),encounterMinutes:""+3*d,phoneType:"bogus phone xyz"+d,distance:d%3==0?"risky":"bogus",severity:["low","medium","high"][(d-1)%3]};b.push(e)}else for(var f in a){var g=a[f];if(g.encounters)for(var h in g.encounters){var i=g.encounters[h],j={};g.userInfo?(j.nameEn=g.userInfo.nameEn,j.identifier=g.userInfo.userId?g.userInfo.userId:g.userInfo.id,j.mobile=g.userInfo.mobile,j.id=g.userInfo.id):(j.nameEn="N/A",j.identifier="N/A",j.mobile="N/A",j.id="N/A"),j.encounterDate=moment.unix(h).format("MM/DD/YYYY hh:mm A"),j.encounterMinutes=i.minutes,j.phoneType=g.model,j.distance=i.distance,j.severity=i.risk,b.push(j)}}k.gridData=b,k.loading=!1,0==k.gridData.length&&(k.noContacts=!0)}else k.loading=!1},function(a,b){k.showAlert("danger",b||a),k.showLoading=!1}):(k.loading=!1,k.showAlert("danger",k.defaultErrorMsg))},function(a){k.loading=!1,k.showAlert("danger",k.defaultErrorMsg)})},k.search=function(a){b.$broadcast("schemaFormValidate"),a.$valid&&(k.showSearchLoading=!0,k.userInfo=null,k.usersInfo=null,k.latestTriggered=!1,k.deviceId=a.searchBox.$modelValue.replace(/\s/g,""),k.searchPassport=a.searchBox.$modelValue.replace(/\s/g,""),k.latestTriggeredMap[k.searchPassport]=!1,k.getProfile())},k.getProfile=function(a){k.showProfileLoading=!0;var b={id:k.deviceId};void 0!==a&&(b={deviceId:a}),d.get(k.backendApiGetProfile,b).then(function(b,c){if("failure"==b.status)k.success=!1,k.showSearchLoading=!1,k.showAlert("danger",k.defaultErrorMsg);else{if(b.documents&&b.documents.length>0){if(1!=b.documents.length)return k.usersInfo=b.documents,k.showProfileLoading=!1,void(k.showSearchLoading=!1);k.userInfo=b.documents[0],k.showProfileLoading=!1,k.showSearchLoading=!1,k.mainLoading=!1,k.getTestData(),k.loadContacts()}else k.userInfo=null,k.showProfileLoading=!1,k.showSearchLoading=!1,k.mainLoading=!1,a&&k.showAlert("danger","User Not Found.");k.success=!0}},function(a){k.showProfileLoading=!1,k.mainLoading=!1,k.showAlert("danger",k.defaultErrorMsg)})},k.getTestData=function(){k.showGrid=!1;var a={deviceId:k.userInfo.id},b=f.defer(),c=new FormData;for(var e in a)c.append(e,a[e]);return k.showTestResultLoading=!0,d.post(k.backendApiAccountDetails,a,null,!1).then(function(a,c){"failure"==a.status?(k.showTestResultLoading=!1,k.showAlert("danger",k.defaultErrorMsg)):k.getJobStatus(k.backendApiAccountDetails,{jobId:a.jobId},30,function(d){k.userInfo.testDate=d.date?d.date:"Not available",k.userInfo.testResult=d.riskMessage.en,k.userInfo.risk=d.risk,k.gridOptions=k.gridOptionsRef.slice(0),"high"==k.userInfo.risk&&k.gridOptions.push(k.gridOptionsAction),k.showGrid=!0,k.showTestResultLoading=!1,b.resolve(a,c)},function(a){k.showAlert("danger",k.defaultErrorMsg),console.dir(a),k.showTestResultLoading=!1,k.showSearchLoading=!1,b.reject(a)})},function(a){k.showAlert("danger",k.defaultErrorMsg),k.showTestResultLoading=!1,b.reject(a)}),b.promise},k.getLatestData=function(){k.latestTriggeredMap[k.userInfo.id]=!0,k.latestTriggered=!0,console.log("get latest data is triggered"),d.get(k.backendApiScheduleTriggerDataUpload,{deviceId:k.userInfo.id}).then(function(a){console.dir(a),k.showAlert("success","Job created successfully.")},function(a){console.dir(a),k.showAlert("danger",a.errorDetail)})},k.doConfirmAmberFlag=function(a){k.closeAlert();var b=a&&a.data&&a.data.nameEn?a.data.nameEn:"Unknown",c=i.confirm().title("Confirm flagging?").clickOutsideToClose(!0).textContent('This person "'+b+'" will be flagged as risky.').ok("Confirm").cancel("Cancel");i.show(c).then(function(){console.log("Amber flagging of "+b+" confirmed");var c=function(a){console.log("api success: ",a),k.showAlert("success","User "+b+" successfully flagged as risky user")},e=function(a){console.log("api failed: ",a),k.showAlert("danger","User "+b+" was not flagged as risky user: "+a.errorDetail)};d.post(k.backendApiFlagAmber,{investigatedDeviceId:k.userInfo.id,encounteredDeviceId:a.data.id}).then(function(b,d){b&&b.status&&"failure"==b.status?"function"==typeof e&&e(b):k.getJobStatus(k.backendApiFlagAmber,{jobId:b.result.jobId,investigatedDeviceId:k.userInfo.id,encounteredDeviceId:a.data.id},30,function(a){"function"==typeof c&&c(a)},function(a){"function"==typeof e&&e(a)})},function(a){"function"==typeof e&&e(a)})},function(){console.log("Amber flagging of "+b+" cancelled")})},k.doScrollToGrid=function(){document.getElementById("encountersGridDiv").scrollIntoView()},k.viewAsGraph=function(){k.showGrid?(d3.selectAll(".graph-container svg").remove(),k.showGrid=!1,k.graphData={nodes:[],links:[]},k.graphData.nodes.push({name:k.userInfo.nameEn,group:1,risk:"none"}),angular.forEach(k.gridData,function(a,b){k.graphData.nodes.push({name:a.nameEn,group:1,risk:a.severity}),k.graphData.links.push({source:b+1,target:0,value:5})}),k.buildGraph()):k.showGrid=!0},k.buildGraph=function(){var a=d3.select(document.getElementById("graphDiv")).append("svg").attr("width",b).attr("height",c),b=960,c=500,a=d3.select(document.getElementById("graphDiv")).append("svg").attr("width",b).attr("height",c),d=d3.layout.force().gravity(.05).distance(200).charge(-100).size([b,c]);d.nodes(k.graphData.nodes).links(k.graphData.links).start();var e=a.selectAll(".link").data(k.graphData.links).attr("class","links").enter().append("line").attr("class","link"),f=a.selectAll(".node").data(k.graphData.nodes).enter().append("g").attr("class","node").call(d.drag);f.append("svg:circle").attr("r",function(a){return 30}).style("fill","#eee").style("stroke",function(a){return"high"==a.risk?"#f00":"low"==a.risk?"#00f":"#000"}),f.append("text").attr("class","nodetext").attr("x",20).attr("y",40).attr("fill","#000").text(function(a){return a.name}),d.on("tick",function(){e.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y}),f.attr("transform",function(a){return"translate("+a.x+","+a.y+")"})})}}]),myApp.controller("notInQuarantineCtrl",["$scope","$rootScope","httpClient",function(a,b,c){var d=this;d.gridClass="",d.renderGrid=!1,d.gridAPI="admin/profile/listOfUsersNotInQuarantine",d.title="Users Not In Quarantine",d.colDef=[{headerName:"Id",field:"value",cellClass:"textWrap",editable:!1,headerCheckboxSelection:!1,checkboxSelection:!1},{headerName:"Type",field:"type",cellClass:"textWrap",editable:!1,headerCheckboxSelection:!1,checkboxSelection:!1}],d.init=function(){d.renderGrid=!0}}]),myApp.controller("pauseRequestCtrl",["$scope","$rootScope","httpClient","$timeout","$uibModal",function(a,b,c,d,e){var f=this;f.gridClass="",f.gridAPI="admin/quarantine/pausePermit/getListApi",f.title="Approved Pause Permits",f.filter="all",f.filterParams={filter:f.filter},f.colDef=[{headerName:"Id",field:"userId",cellClass:"textWrap",editable:!1,headerCheckboxSelection:!1,checkboxSelection:!1,cellRenderer:function(a){return a.value||"N/A"}},{headerName:"Phone",field:"mobile",cellClass:"textWrap",editable:!1,headerCheckboxSelection:!1,checkboxSelection:!1,cellRenderer:function(a){return a.value||"N/A"}},{headerName:"Starts",field:"startDate",cellClass:"textWrap",editable:!1,headerCheckboxSelection:!1,checkboxSelection:!1,cellRenderer:function(a){if(a.value){var b=moment(parseInt(a.value));b.isValid()||(b=moment.unix(parseInt(a.value)));return b.format("DD-MMM-YYYY hh:mma")}return a.value}},{headerName:"Ends",field:"endDate",cellClass:"textWrap",editable:!1,headerCheckboxSelection:!1,checkboxSelection:!1,cellRenderer:function(a){if(a.value){var b=moment(parseInt(a.value));b.isValid()||(b=moment.unix(parseInt(a.value)));return b.format("DD-MMM-YYYY hh:mma")}return a.value}},{headerName:"Comments",field:"comments",cellClass:"textWrap",editable:!1,width:300}],f.init=function(){f.renderGrid=!0},f.setFilter=function(a){f.renderGrid=!1,console.log("setFilter",a),f.filterParams={filter:a},d(function(){f.renderGrid=!0},500)}}]),angular.module("QmcSearch",["List","DataService"]),angular.module("QmcSearch").component("scriptrSearchDevices",{bindings:{label:"@",api:"@",selectedDevice:"@",defaultPath:"@",placeholder:"@",allPath:"@",searchFields:"@",onFormatData:"&",appendAllEntry:"<?",titleField:"@"},templateUrl:"/app/view/javascript/components/search/search.html",controller:["httpClient","wsClient","dataService","$scope","$rootScope","$window","$location","$route","$routeParams",function(a,b,c,d,e,f,g,h,i){var j=this;this.$onInit=function(){j.titleField=j.titleField?j.titleField:"id",j.searchFields=j.searchFields?j.searchFields:"id,name",j.appendAllEntry=void 0===j.appendAllEntry&&null===j.appendAllEntry||j.appendAllEntry,this.selectedDevice&&(j.selectedValue=j.selectedDevice,this.params={id:j.selectedDevice}),this.defaultPath||(this.defaultPath="/map")},j.listCallback=function(a,b){"function"==typeof j.onFormatData()&&(a=j.onFormatData()(a,j));var c=[];return b.localData&&0!=b.localData.length?b.localData.length>0&&(c=b.localData.concat(a)):(j.appendAllEntry&&(c=[{id:"all",name:"All"}]),c=c.concat(a)),_.uniq(c,"id")},this.onInputChanged=function(a){j.searchText={search:a}},j.onSelect=function(a){if(void 0!=a)return a&&(j.selectedValue=a.originalObject.id,j.params={id:a.originalObject.id}),a&&"all"==a.originalObject.id?e.$broadcast("mapRerender"):e.$broadcast("mapShowInfoWindowOnMarker","simulator_"+a.originalObject.id),g.search({}),a}}]}),agGrid.initialiseAgGridWithAngular1(angular),angular.module("QmcGrid",["agGrid","ui.bootstrap","ngRoute"]),angular.module("QmcGrid").component("scriptrQmcGrid",{bindings:{onLoad:"&onLoad",gridDataIdentifierProperty:"@",columnsDefinition:"<columnsDefinition",rowHeight:"<?",enableServerSideSorting:"<?",enableServerSideFilter:"<?",refreshOnEdit:"<?",enableColResize:"<?",pagination:"@",enableDeleteRow:"<?",fixedHeight:"<?",enableAddRow:"<?",cellEditable:"<?",enableClientSideSorting:"<?",api:"@",onInsertRowScript:"@",onDeleteRowScript:"@",transport:"@",enableClientSideFilter:"<?",rowModelType:"@",rowModelSelection:"@",rowDeselection:"<?",onSelectionChanged:"&?",rowData:"<?",suppressFilter:"<?",gridHeight:"@",paginationPageSize:"<?",paginationOverflowSize:"<?",maxConcurrentDatasourceRequests:"<?",paginationInitialRowCount:"<?",maxPagesInCache:"<?",apiParams:"<?",deleteParams:"<?",addParams:"<?",editParams:"<?",onFormatData:"&",onCellValueChanged:"&",onCellClicked:"&",msgTag:"@",class:"@",defaultCellRenderer:"&",onGridReady:"&",useWindowParams:"@",onRowDoubleClicked:"&",sizeColumnsToFit:"<?",onGetRowClass:"&?",onGetNodeChildDetails:"&?",onIsExternalFilterPresent:"&?",onDoesExternalFilterPass:"&?",gridEventsId:"@"},templateUrl:"/app/view/javascript/components/grid/grid.html",controller:["$scope","$window","$uibModal","$timeout","wsClient","dataStore","$routeParams",function(a,b,c,d,e,f,g){var h=this;h.broadcastData=null,this.dataSource={getRows:function(a){if(null!=h.broadcastData){if(null!=h.broadcastData.api)var b=h.broadcastData.api;else var b=h.api;if(null!=h.broadcastData.params&&(h.apiParams=h.broadcastData.params),null!=h.broadcastData.transport)var c=h.broadcastData.transport;else var c=h.transport}else var b=h.api,c=h.transport;var d=h.buildParams(a),e=null;"function"==typeof h.onFormatData()&&(e=function(a){return h.onFormatData()(a)}),f.getGridData(b,d,c,e).then(function(b,c){if(b&&b.documents){var d=b.documents,e=parseInt(b.count),f=h.cleanRows(d);if(a.successCallback(f,e),h.sizeColumnsToFit&&h.gridOptions.api.sizeColumnsToFit(),h.gridOptions.api.doLayout(),null==f||0==f.length){h.gridOptions.api.showNoRowsOverlay();angular.element(document.querySelector("#btNext")).attr("disabled","true"),0==e&&(angular.element(".ag-paging-page-summary-panel > span[ref=lbTotal]")[0].innerHTML=1)}else h.gridOptions.api.hideOverlay()}else a.failCallback(),h.gridOptions.api.showNoRowsOverlay()},function(a){console.log("reject",a)})}},this.$onDestroy=function(){h.msgTag&&e.unsubscribe(h.msgTag,null,a.$id),console.log("destory Grid")},this.cleanRows=function(a){Array.isArray(a)||(a=[a]);for(var b=!1,c=0;c<a.length;c++)for(row in a[c])if("key"!=row){b=!1;for(var d=0;d<h.gridOptions.columnDefs.length;d++)if(row==h.gridOptions.columnDefs[d].field){b=!0;break}b||delete a[c][row]}return a},this._createNewDatasource=function(){this.gridOptions.api.setDatasource(this.dataSource)},this.$onInit=function(){this._dataIdentifierProperty=this.gridDataIdentifierProperty?this.gridDataIdentifierProperty:"key",this.useWindowParams=this.useWindowParams?this.useWindowParams:"true",this.sizeColumnsToFit=void 0===this.sizeColumnsToFit||this.sizeColumnsToFit,this.gridOptions={angularCompileRows:!0,domLayout:"autoHeight",rowHeight:this.rowHeight?this.rowHeight:25,enableSorting:void 0===this.enableClientSideSorting||this.enableClientSideSorting,enableServerSideSorting:void 0===this.enableServerSideSorting||this.enableServerSideSorting,enableServerSideFilter:void 0===this.enableServerSideFilter||this.enableServerSideFilter,enableColResize:void 0!==this.enableColResize&&this.enableColResize,enableFilter:!0,columnDefs:this.columnsDefinition,pagination:void 0!==this.pagination&&this.pagination,cacheBlockSize:this.paginationPageSize?this.paginationPageSize:50,rowData:this.rowData?this.rowData:null,rowModelType:this.api?"infinite":"",rowSelection:this.rowModelSelection?this.rowModelSelection:"multiple",paginationPageSize:this.paginationPageSize?this.paginationPageSize:50,
getRowClass:function(a){if(null!=h.onGetRowClass&&"function"==typeof h.onGetRowClass())return h.onGetRowClass()(a,h.gridOptions,h.gridApi)},getNodeChildDetails:function(a){if(null!=h.onGetNodeChildDetails&&"function"==typeof h.onGetNodeChildDetails())return h.onGetNodeChildDetails()(a)},isExternalFilterPresent:function(a){if(null!=h.onIsExternalFilterPresent&&"function"==typeof h.onIsExternalFilterPresent())return h.onIsExternalFilterPresent()()},doesExternalFilterPass:function(a){if(null!=h.onDoesExternalFilterPass&&"function"==typeof h.onDoesExternalFilterPass())return h.onDoesExternalFilterPass()(a)},overlayLoadingTemplate:'<span class="ag-overlay-loading-center"><i class="fa fa-spinner fa-spin fa-fw fa-2x"></i> Please wait while your rows are loading</span>',defaultColDef:{filterParams:{apply:!0},suppressFilter:void 0!==this.suppressFilter&&this.suppressFilter,editable:void 0===this.cellEditable||this.cellEditable,cellRenderer:"function"==typeof this.defaultCellRenderer()?this.defaultCellRenderer():null},onSelectionChanged:function(){if(null!=h.onSelectionChanged&&"function"==typeof h.onSelectionChanged())return h.onSelectionChanged()(h.gridOptions,h.gridApi)},onCellClicked:function(a){if(null!=h.onCellClicked&&"function"==typeof h.onCellClicked())return h.onCellClicked()(a,h.gridOptions,h.gridApi)},onCellValueChanged:function(a){},onRowValueChanged:function(a){},onGridReady:function(a){if(console.log("the grid is now ready"),d(function(){h.gridOptions.api=a.api,h.gridApi=a.api},3e3),"function"==typeof h.onGridReady()&&h.onGridReady()(h),a.api.filterManager.availableFilters.text.CONTAINS="startsWith",void 0===h.rowData||null==h.rowData||h.rowData&&0==h.rowData.length?h.api?h._createNewDatasource():a.api.setRowData([]):h.sizeColumnsToFit&&a.api.sizeColumnsToFit(),this.columnsDefinition)for(var b=0;b<this.columnsDefinition.length;b++)this.columnsDefinition[b].hasOwnProperty("type")&&"numeric"==this.columnsDefinition[b].type&&(this.columnsDefinition[b].filter="number")},onGridSizeChanged:function(a){h.sizeColumnsToFit&&h.gridOptions.api.sizeColumnsToFit()}},null!=h.onRowDoubleClicked&&"function"==typeof h.onRowDoubleClicked()&&(h.gridOptions.onRowDoubleClicked=function(a){return h.onRowDoubleClicked()(a)}),this.fixedHeight=void 0===this.fixedHeight||this.fixedHeight,this.style={height:"100%",width:"100%"},this.refreshOnEdit=void 0!==this.refreshOnEdit&&this.refreshOnEdit,this.transport=this.transport?this.transport:"wss",this.disableDeleteRow=1!=this.enableDeleteRow,this.disableAddRow=1!=this.enableAddRow,this.mode="infinite"==this.gridOptions.rowModelType?"infinite":"normal",h.msgTag&&f.subscribe(this.onServerCall,h.msgTag,a),a.$on("updateGridData",function(a,b){h.broadcastData=b,h._createNewDatasource()}),a.$on("runExternalFilter-"+h.gridEventsId,function(a,b){h.gridOptions.api.onFilterChanged()})},this.closeAlert=function(){this.show=!1},this.showAlert=function(a,b){h.message={type:a,content:b},h.showError=!0,d(function(){h.showError=!1},5e3)},this._saveData=function(a){if(a.data&&a.data[h._dataIdentifierProperty]){var b=a.data;if(b.action="edit",this.editParams)for(var c in this.editParams)b[c]=this.editParams[c];f.gridHelper(h.api,b).then(function(a,b){h.gridOptions.api.hideOverlay(),!a||"success"!=a.result&&"success"!=a.status?(h.undoChanges(),a&&a.errorDetail?h.showAlert("danger",a.errorDetail):h.showAlert("danger","An error has occured")):h.refreshOnEdit&&h.onServerCall(a)},function(a){h.gridOptions.api.hideOverlay(),console.log("reject",a),h.showAlert("danger","An error has occured")})}else{var b=a.data;if(b.action="add",this.addParams)for(var c in this.addParams)b[c]=this.addParams[c];f.gridHelper(h.api,a.data).then(function(a,b){h.gridOptions.api.hideOverlay(),!a||"success"!=a.result&&"success"!=a.status?(h.undoChanges(),a&&a.errorDetail?h.showAlert("danger",a.errorDetail):h.showAlert("danger","An error has occured")):h.refreshOnEdit&&h.onServerCall(a)},function(a){h.gridOptions.api.hideOverlay(),console.log("reject",a),h.showAlert("danger","An error has occured")})}},this.onAddRow=function(){for(var a={},b=0;b<h.gridOptions.columnDefs.length;b++)a[h.gridOptions.columnDefs[b].field]="";h.gridOptions.api.insertItemsAtIndex(0,[a]),h.gridOptions.api.setFocusedCell(0,h.gridOptions.columnDefs[0].field),h.gridOptions.api.startEditingCell({rowIndex:0,colKey:h.gridOptions.columnDefs[0].field,charPress:h.gridOptions.columnDefs[0].field})},this.openConfirmationPopUp=function(){if(h.gridOptions.api.getSelectedNodes().length>0){c.open({animation:!0,component:"deleteConfirmation",size:"md",resolve:{grid:function(){return h}}})}},this.onRemoveRow=function(a){if("infinite"==h.gridOptions.rowModelType)if(h.api){for(var b=h.gridOptions.api.getSelectedNodes(),c=[],d=0;d<b.length;d++)c.push(b[d].data[h._dataIdentifierProperty]);if(c.length>0){h.gridOptions.api.showLoadingOverlay();var e={keys:c,action:"delete"};if(this.deleteParams)for(var a in this.deleteParams)e[a]=this.deleteParams[a];f.gridHelper(h.api,e).then(function(a,b){h.gridOptions.api.hideOverlay(),!a||"success"!=a.result&&"success"!=a.status?a&&a.errorDetail?h.showAlert("danger",a.errorDetail):h.showAlert("danger","An error has occured"):(h.showAlert("success","Row(s) deleted successfuly"),h.onServerCall(a))},function(a){h.gridOptions.api.hideOverlay(),console.log("reject",a),h.showAlert("danger","An error has occured")})}}else h.showAlert("danger","No script defined for delete row");else{var b=h.gridOptions.api.getSelectedNodes();h.gridOptions.api.removeItems(b)}},this.onServerCall=function(a){h.gridOptions.api.refreshInfiniteCache()},this.undoChanges=function(a){if(h.oldEditedValue){h.gridOptions.api.forEachNode(function(a){a.childIndex!=h.editedChildIndex&&a.id!=h.editedChildIndex||a.setSelected(!0,!0)});h.gridOptions.api.getSelectedNodes()[0].data[h.editedColumn]=h.oldEditedValue,h.gridOptions.api.refreshView()}else h.gridOptions.api.refreshInfiniteCache()},this.onFilterChanged=function(){this.gridOptions.enableServerSideFilter=!1,this.gridOptions.api.setQuickFilter(this.quickFilterValue),this.gridOptions.enableServerSideFilter=!0},this.onServerFilterChanged=function(){h._createNewDatasource()},this.buildParams=function(a){var b=h.serverFilterText,c=null,d=a.endRow/this.gridOptions.paginationPageSize;if(a.sortModel&&a.sortModel.length>0){var e=a.sortModel[0].sort,f=a.sortModel[0].colId;c=this.gridOptions.api.getColumnDef(f).type?this.gridOptions.api.getColumnDef(f).type:null}if(a.filterModel)for(p in a.filterModel){b=a.filterModel[p].filter;var i=a.filterModel[p].type,j=p;c=this.gridOptions.api.getColumnDef(j).type?this.gridOptions.api.getColumnDef(j).type:null}var k={resultsPerPage:this.gridOptions.paginationPageSize,pageNumber:d};if(f&&(k.sortingColumnName=f),j&&(k.filterColumnName=j),e&&(k.sort=e),c&&(k.sortType=c),b&&(k.queryFilter=b),i&&(k.queryType=i),k.startRow=a.startRow,k.endRow=a.endRow,this.apiParams)for(var l in this.apiParams)k[l]=this.apiParams[l];return h.useWindowParams&&"true"==h.useWindowParams&&(k=angular.merge(k,g)),k}}]}),angular.module("Grid").service("dataStore",["httpClient","wsClient","$q",function(a,b,c){this.subscribe=function(a,c,d){b.onReady.then(function(){b.subscribe(c,a.bind(self),d.$id)})},this.gridHelper=function(b,d){var e=c.defer();return a.get(b,d,"grid").then(function(a,b){e.resolve(a,b)},function(a){e.reject(a)}),e.promise},this.getGridData=function(d,e,f,g){var h=c.defer();return"https"==f?(a.get(d,e).then(function(a,b){if(g&&(a=g(a)),a&&a.documents){var a={documents:a.documents,count:a.count};h.resolve(a,b)}else h.resolve(null,b)},function(a){h.resolve(null),h.reject(a)}),h.promise):"wss"==f?d&&void 0!==d?(b.onReady.then(function(){b.call(d,e,"grid").then(function(a,b){if(g&&(a=g(a)),a&&a.documents){var a={documents:a.documents,count:a.count};h.resolve(a,b)}else h.resolve(null,b)},function(a){h.resolve(null),h.reject(a)})}),h.promise):(b.onReady.then(function(){b.publish(e,"publish").then(function(a,b){if(a&&a.documents){var a={documents:a.documents,count:a.count};h.resolve(a,b)}else h.resolve(null,b)},function(a){h.resolve(null),h.reject(a)})}),h.promise):void 0}}]),angular.module("Grid").component("deleteConfirmation",{bindings:{resolve:"<",close:"&",dismiss:"&"},templateUrl:"/UIComponents/dashboard/frontend/components/grid/popup.html",controller:["$scope",function(a){this.onSubmit=function(){this.resolve.grid.onRemoveRow(),this.close({$value:!0})},this.onCancel=function(){this.dismiss({$value:!1})}}]}),angular.module("QmcForms",["underscore","btford.markdown","schemaForm","ui.bootstrap","ngRoute","ngAnimate","ngSanitize","WsClient","HttpClient","DataService","ngMaterial","ngMessages","material.svgAssetsCache","angularSpectrumColorpicker","angular-underscore/filters","ui.codemirror","mgcrea.ngStrap","mgcrea.ngStrap.modal","pascalprecht.translate","ui.select","ui.highlight","mgcrea.ngStrap.select"]),angular.module("QmcForms").component("scriptrQmcFormOverlay",{bindings:{resolve:"<",close:"&",dismiss:"&"},templateUrl:"/app/view/javascript/components/forms/overlayForm.html",controller:["$scope",function(a){var b=this;this.$onInit=function(){this.widget=this.resolve.widget,a.$broadcast("schemaFormRedraw"),this.frmGlobalOptions={destroyStrategy:"remove",formDefaults:{feedback:!1}},this.widget&&(this.widget.schema&&(this.schema=angular.copy(this.widget.schema)),this.widget.form&&(this.form=angular.copy(this.widget.form)),this.model=this.widget.options?angular.copy(this.widget.options):{},this.widget.onFormModelChange&&(this.frmGlobalOptions.formDefaults.onChange=this.widget.onFormModelChange))},this.highlightTabs=function(a){var b=$('form[name="'+a+'"]'),c=b.find("ul li"),d=b.find(".tab-pane")||[];b.find("ul li a span.badge").remove();for(var e=0;e<d.length;e++){var f=$(d[e]).find("div.ng-invalid").length;f>0&&$(c[e].childNodes[0]).append('<span class="badge sf-badge-error">'+f+"</span>")}},this.onSubmit=function(c){a.$broadcast("schemaFormValidate"),console.log(this.model),setTimeout(function(){b.highlightTabs(c.$name)},100),c.$valid&&(this.close({$value:this.model}),console.log("component_form_parent",this.model))},this.onCancel=function(a){this.schema={},this.form={},this.model=angular.copy(this.widget.options),this.dismiss({$value:"cancel"}),console.log("Dissmissed")}}]});var changePasswordForm={form:[{type:"section",htmlClass:"row",items:[{type:"section",htmlClass:"col-xs-4",items:[{key:"oldPassword",type:"password"},{key:"newPassword",type:"password",ngModelOptions:{allowInvalid:!0},onChange:function(a,b,c,d){console.log(c),a!=c.confirmPassword?d.$root.$broadcast("schemaForm.error.newPassword","doNotMatch",!1):(d.$root.$broadcast("schemaForm.error.newPassword","doNotMatch",!0),d.$root.$broadcast("schemaForm.error.confirmPassword","doNotMatch",!0))}},{key:"confirmPassword",type:"password",ngModelOptions:{allowInvalid:!0},onChange:function(a,b,c,d){console.log(c),a!=c.newPassword?d.$root.$broadcast("schemaForm.error.confirmPassword","doNotMatch",!1):(d.$root.$broadcast("schemaForm.error.newPassword","doNotMatch",!0),d.$root.$broadcast("schemaForm.error.confirmPassword","doNotMatch",!0))}}]}]}],schema:{type:"object",title:"Schema",properties:{oldPassword:{title:"Current Password",type:"string"},newPassword:{title:"New password",type:"string",validationMessage:{doNotMatch:"Passwords do not match."}},confirmPassword:{type:"string",title:"Confirm password",validationMessage:{doNotMatch:"Passwords do not match."}}},required:["currentPassword","newPassword","confirmPassword"]}};myApp.constant("changePasswordForm",changePasswordForm).controller("changePasswordCtrl",["$scope","$rootScope","wsClient","httpClient","$sce","$route","$routeParams","$interval","$filter","$location","changePasswordForm","$cookies","$timeout",function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n=this;n.init=function(){n.frmGlobalOptions={destroyStrategy:"remove",formDefaults:{feedback:!1},validationMessage:{302:"Required field."}},n.schema=angular.copy(k.schema),n.form=angular.copy(k.form),n.model={}},n.changePassword=function(b){if(a.$broadcast("schemaFormValidate"),b.$valid){var e={oldPassword:n.model.oldPassword,newPassword:n.model.newPassword};d.get("login/api/changePassword",e).then(function(a,b){a&&a.token&&(console.log("data: ",a),n.successMsg="Password changed successfully.",window.document.cookie="token="+a.token+";expires="+a.expires+";Path=/;Secure",window.document.cookie="user="+JSON.stringify(a.user)+";expires="+a.expires+";Path=/;Secure",d.updateToken(a.token),c.updateTokenAndReconnect()),console.log("resolve",a)},function(a){"INVALID_CREDENTIALS"==a.errorCode?n.errorMsg="Invalid current password.":n.errorMsg=a.errorDetail,console.log("reject",a)})}},n.closeMessage=function(){n.successMsg="",n.errorMsg=""}}]),myApp.constant("constants",{appTitle:"Saepio - Stay Safe",source:{branch:{normal:{mapMarker:{url:"{{cdnImagesPath}}normal-bank.png"}},alert:{mapMarker:{url:"{{cdnImagesPath}}alert-bank.png"}}},headOffice:{normal:{mapMarker:{url:"{{cdnImagesPath}}normal-corporate.png"}},alert:{mapMarker:{url:"{{cdnImagesPath}}alert-corporate.png"}}},corporate:{normal:{mapMarker:{url:"{{cdnImagesPath}}normal-corporate.png"}},alert:{mapMarker:{url:"{{cdnImagesPath}}alert-corporate.png"}}},ship:{normal:{mapMarker:{url:"{{cdnImagesPath}}normal-ship.png"}},alert:{mapMarker:{url:"{{cdnImagesPath}}alert-ship.png"}}}},quarantineState:{warn:{mapMarker:{url:"{{cdnImagesPath}}orange.png"}},inQuarantine:{mapMarker:{url:"{{cdnImagesPath}}green.png"}},alert:{mapMarker:{url:"{{cdnImagesPath}}red.png"}},failure:{mapMarker:{url:"{{cdnImagesPath}}red.png"}},breachConfinement:{mapMarker:{url:"{{cdnImagesPath}}red.png"}},escalated:{mapMarker:{url:"{{cdnImagesPath}}red.png"}}},sources:{simulator:{mapMarker:{url:"{{cdnImagesPath}}/sick.png"}}},sourcesLabels:{simulator:"Quarantine Command center"},infoWindows:{icons:{id:'<img alt="passport icon" class="modalIcons" src="{{cdnImagesPath}}passport.png">',phone:'<img alt="phone icon" class="modalIcons" src="{{cdnImagesPath}}phone.png" />',optimalOccupancy:'<img alt="phone icon" class="modalIcons" src="{{cdnImagesPath}}optimal-occupancy.png" />',maxOccupancy:'<img alt="phone icon" class="modalIcons" src="{{cdnImagesPath}}max-occupancy.png" />',averageOccupancy:'<img alt="phone icon" class="modalIcons" src="{{cdnImagesPath}}average-occupancy.png" />',testresult:'<img alt="test result icon" class="modalIcons" src="{{cdnImagesPath}}testResult.png" />',coronatest:'<img alt="calendar icon" class="modalIcons" src="{{cdnImagesPath}}calender.png" />',missed:'<img alt="missed scan icon" class="modalIcons" src="{{cdnImagesPath}}error.png" />',clock:'<img alt="clock icon" class="modalIcons" src="{{cdnImagesPath}}clock.png" />',alarmon:'<img alt="alarm on icon" class="modalIcons" src="{{cdnImagesPath}}alarmOn.png" />',alarmoff:'<img alt="alarm off icon" class="modalIcons" src="{{cdnImagesPath}}alarmOff.png" />',timer:'<img alt="time remaining icon" class="modalIcons" src="{{cdnImagesPath}}timer.png" />',quarantine:'<img alt="calendar icon" src="{{cdnImagesPath}}calender.png" />'}}});